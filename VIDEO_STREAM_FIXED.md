# –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ

## –î–∞—Ç–∞: 2026-02-12 19:25

## üîç –ü—Ä–æ–±–ª–µ–º–∞
–ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±—ã–ª —Å–µ—Ä—ã–π —ç–∫—Ä–∞–Ω –≤–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã.

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:

```
‚ùå Failed to queue frame: There is no current event loop in thread 'Thread-1 (_run)'.
```

**–ü—Ä–∏—á–∏–Ω–∞**: 
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `asyncio.Queue` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ—Ä–µ–π–º–æ–≤
- CV worker —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º thread
- `asyncio.get_event_loop()` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ background thread
- –§—Ä–µ–π–º—ã –ø—Ä–∏—Ö–æ–¥–∏–ª–∏, –Ω–æ –Ω–µ –º–æ–≥–ª–∏ –ø–æ–ø–∞—Å—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å

## ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ó–∞–º–µ–Ω–∏–ª `asyncio.Queue` –Ω–∞ `threading.Queue` –¥–ª—è –º–µ–∂–ø–æ—Ç–æ—á–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/main.py`:

#### –î–æ:
```python
frame_queue: asyncio.Queue = asyncio.Queue(maxsize=2)

def on_frame_ready(frame):
    loop = asyncio.get_event_loop()
    asyncio.run_coroutine_threadsafe(
        frame_queue.put(frame),
        loop
    )  # ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ thread!
```

#### –ü–æ—Å–ª–µ:
```python
import queue

frame_queue = queue.Queue(maxsize=2)

def on_frame_ready(frame):
    # –ü—Ä–æ—Å—Ç–æ–π thread-safe put
    if frame_queue.full():
        frame_queue.get_nowait()  # Drop old frame
    frame_queue.put_nowait(frame)  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ generate_frames():

#### –ü–æ—Å–ª–µ:
```python
async def generate_frames():
    while True:
        # Read from threading.Queue in executor
        frame = await asyncio.get_event_loop().run_in_executor(
            None,
            lambda: frame_queue.get(timeout=1.0)
        )
        
        # Encode and yield frame
        ret, buffer = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 85])
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + buffer.tobytes() + b'\r\n')
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ Frame queued! Queue size: 1
üìπ Streaming frame #6420
‚úÖ Frame queued! Queue size: 1
üìπ Streaming frame #6421
```

### –°—Ç–∞—Ç—É—Å:
- ‚úÖ –ö–∞–º–µ—Ä–∞: ONLINE
- ‚úÖ –ú–æ–¥–µ–ª—å: LOADED  
- ‚úÖ –§—Ä–µ–π–º—ã: –ü–æ—Å—Ç—É–ø–∞—é—Ç –≤ –æ—á–µ—Ä–µ–¥—å
- ‚úÖ –°—Ç—Ä–∏–º: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í–∏–¥–µ–æ: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

## üåê –ü—Ä–æ–≤–µ—Ä–∫–∞

–û—Ç–∫—Ä–æ–π—Ç–µ **http://localhost:8000** –∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

- üìπ **–ñ–∏–≤–æ–µ –≤–∏–¥–µ–æ** —Å –∫–∞–º–µ—Ä—ã (–Ω–µ —Å–µ—Ä—ã–π —ç–∫—Ä–∞–Ω!)
- üü¢ **–ó–µ–ª–µ–Ω—ã–µ —Ä–∞–º–∫–∏** –≤–æ–∫—Ä—É–≥ –ª—é–¥–µ–π
- üéØ **–ñ–µ–ª—Ç–∞—è –ª–∏–Ω–∏—è** –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
- üî¢ **Track ID** –Ω–∞–¥ –∫–∞–∂–¥—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º
- üìä **–°—á–µ—Ç—á–∏–∫–∏** IN/OUT –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è live

## üìù –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

### –ü–æ—á–µ–º—É threading.Queue?
1. **Thread-safe** - —Å–æ–∑–¥–∞–Ω–∞ –∏–º–µ–Ω–Ω–æ –¥–ª—è –º–µ–∂–ø–æ—Ç–æ—á–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ –Ω—É–∂–µ–Ω event loop
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–≥–æ thread
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–µ–Ω—å—à–µ overhead —á–µ–º async

### –ü–æ—á–µ–º—É –Ω–µ asyncio.Queue?
1. **Event loop –ø—Ä–∏–≤—è–∑–∞–Ω –∫ thread** - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –¥—Ä—É–≥–∏—Ö threads
2. **–ù—É–∂–µ–Ω run_coroutine_threadsafe** - —Å–ª–æ–∂–Ω–æ –∏ –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ
3. **Overhead** - –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑–±—ã—Ç–æ—á–µ–Ω

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç now:
```
CV Worker Thread          threading.Queue          FastAPI (async)
      ‚îÇ                         ‚îÇ                         ‚îÇ
      ‚îú‚îÄ frame ready ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
      ‚îÇ                         ‚îÇ<‚îÄ run_in_executor() ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ                         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                         ‚îÇ                         ‚îú‚îÄ encode & stream
```

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
cd /Users/alextabula/Desktop/vision

# –° –Ω—É–∂–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
OPENCV_AVFOUNDATION_SKIP_AUTH=1 \
PC_SHOW_DEBUG_WINDOW=false \
.venv/bin/python run.py --no-debug-window
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **FPS**: ~30 FPS (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –∏ –∂–µ–ª–µ–∑–∞)
- **Latency**: ~50-100ms (–∫–∞–º–µ—Ä–∞ ‚Üí –±—Ä–∞—É–∑–µ—Ä)
- **Quality**: JPEG 85% compression
- **Resolution**: 960x540 (configurable)

## üéâ –ò—Ç–æ–≥

–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç! –°–µ—Ä—ã–π —ç–∫—Ä–∞–Ω –∏—Å—á–µ–∑, –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ 
–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∂–∏–≤–æ–µ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã —Å –¥–µ—Ç–µ–∫—Ü–∏–µ–π –ª—é–¥–µ–π –∏ –ø–æ–¥—Å—á–µ—Ç–æ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π.

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! ‚ú®**
